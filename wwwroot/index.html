<html>

<head>
    <link rel="stylesheet" href="https://necolas.github.io/normalize.css/8.0.1/normalize.css" />
    <link href="fa/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">

</head>

<body>
    <div class="backdrop"></div>
    <div class="toolbar">
        <i class="fal fa-save fa-2x" onclick="save()"></i>
    </div>
    <div class="info">
        <span contenteditable class="count fal fa-utensils"></i></span>
        <span contenteditable class="preptime fal fa-hat-chef"></span>
        <span contenteditable class="resttime fal fa-snooze"></span>
        <span contenteditable class="cooktime fal fa-oven"></span>
        <span class="mold">
            <img src="https://boutique.guydemarle.com/11017-large_default/moule-flower-power.jpg"
                style="height:75px;width:75px" />
            <span class="name" contenteditable=""></span>
        </span>
    </div>
    <header>
        <h1 contenteditable>C'est quand qu'on mange ? C'est quand qu'on mange ? </h1>
    </header>
    <div class="topings">
        <h2>Ingrédients</h2>
        <ul>
        </ul>
        <button onclick="addTopings()"><i class="fal fa-plus"></i></button>

    </div>
    <div class="steps">
        <h2>Préparation</h2>
        <ol>
        </ol>
        <button onclick="addPrepStep()"><i class="fal fa-plus"></i></button>
        <span style="position: absolute; bottom:5px; padding-left:24px"><a
                href="https://www.guydemarle.com/profil/annep_a143-44563">Anne Penin</a>, conseillère Guy Demarle</span>
    </div>
    <div class="logo">
        <img class="qr" src="./qr_code.svg" style="height:100%" />
        <span class="ad">Retrouvez-moi sur facebook </span>
        <a href="https://www.facebook.com/profile.php?id=100090744024852">
            <img src="./logo.svg" style="height:100%" />
        </a>
    </div>
</body>
<script type="text/javascript">

    if (window.location.pathname)
    {
        fetch(window.location.href.replace(/\.html$/i, '.json')).then(async (res) =>
        {
            const recipe = await res.json();
            document.querySelector('h1').innerText = recipe.title;
            document.querySelector('.info>.count').innerText = recipe.for;
            document.querySelector('.info>.preptime').innerText = recipe.preptime;
            document.querySelector('.info>.resttime').innerText = recipe.resttime;
            document.querySelector('.info>.cooktime').innerText = recipe.cooktime;
            document.querySelector('.info>.mold>.name').innerText = recipe.mold.name;
            document.querySelector('.info>.mold>img').src = recipe.mold.picture;
            recipe.topings.forEach(t =>
            {
                const li = addTopings(false);
                li.querySelector('.quantity').innerText = t.quantity;
                li.querySelector('.unit').innerText = t.unit;
                li.querySelector('.toping').innerText = t.name;
            })
            recipe.steps.forEach(t =>
            {
                const li = addPrepStep(false);
                li.innerText = t;
            })
        })
    }

    dynamic(document.querySelector('.info>.mold>.name'), {
        Enter(ev)
        {
            fetchmold(ev);
            ev.target.blur();
        }
    })
    document.querySelector('.info>.mold').addEventListener('click', () => document.querySelector('.info>.mold>.name').focus());
    async function fetchmold(ev)
    {
        const res = await fetch(ev.target.innerText.replace('boutique.guydemarle.com', 'dev.dragon-angel.fr/proxy/3000/boutique'));
        const content = res.text();
        const dummy = document.createElement('div');
        dummy.innerHTML = await content;
        const meta = Object.fromEntries(Array.from(dummy.querySelectorAll('meta').values()).filter(v => v.attributes.property).map(v => [v.attributes.property.value, v.attributes.content.value]));
        dummy.remove();
        ev.target.innerText = meta['og:title'];
        ev.target.parentNode.querySelector('img').src = meta['og:image'];

    }

    function save()
    {
        const recipe = {
            title: document.querySelector('h1').innerText,
            topings: Array.from(document.querySelectorAll('.topings li')).map(li => ({
                quantity: li.querySelector('.quantity').innerText,
                unit: li.querySelector('.unit').innerText,
                name: li.querySelector('.toping').innerText
            })),
            steps: Array.from(document.querySelectorAll('.steps li')).map(li => li.innerText),
            for: document.querySelector('.info>.count').innerText,
            preptime: document.querySelector('.info>.preptime').innerText,
            resttime: document.querySelector('.info>.resttime').innerText,
            cooktime: document.querySelector('.info>.cooktime').innerText,
            mold: document.querySelector('.info>.mold').innerText,
        };

        fetch(window.location.href, { method: 'POST', body: JSON.stringify(recipe), headers: { 'Content-Type': 'application/json' } });
    }

    function addPrepStep(focus)
    {
        const li = document.createElement('li')
        li.contentEditable = true;
        document.querySelector('.steps ol').appendChild(li);
        dynamic(li);
        if (focus)
            li.focus();
        return li;
    }

    function addTopings(focus)
    {
        const li = document.createElement('li')
        const quantity = document.createElement('span')
        const unit = document.createElement('span')
        const toping = document.createElement('span')
        quantity.classList.add('quantity');
        unit.classList.add('unit');
        toping.classList.add('toping');
        quantity.contentEditable = true;
        unit.contentEditable = true;
        toping.contentEditable = true;
        li.appendChild(quantity);
        li.appendChild(unit);
        li.appendChild(toping);
        // li.contentEditable = true;
        document.querySelector('.topings ul').appendChild(li);
        dynamic(quantity, { Enter(ev) { unit.focus(); ev.preventDefault(); return false } })
        dynamic(unit, { Enter(ev) { toping.focus(); ev.preventDefault(); return false } })
        dynamic(toping, { Enter(ev) { toping.blur(); setTimeout(() => addTopings()); ev.preventDefault(); return false } });
        if (focus)
            quantity.focus();
        return li;
    }

    function dynamic(self, keys)
    {
        keys = Object.assign({}, keys);
        self.addEventListener('keydown', function (ev)
        {
            if (self.innerText === '' && (ev.key == 'Delete' || ev.key == 'Backspace' || ev.key == 'Escape'))
            {
                self.blur();
            }
            else if (this.innerText === '' && ev.key.length > 1 && ev.key !== 'Unidentified')
                self.innerText = ev.key;
            else if (ev.key in keys)
                keys[ev.key](ev);
        });
        self.addEventListener('blur', function (ev)
        {
            let li = self;
            while (li.tagName !== 'LI')
                li = li.parentNode;

            if (li.innerText == '')
                li.remove();
        });
    }
</script>

</html>